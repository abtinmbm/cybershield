{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CyberShield - Security Forum</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Fuse.js for search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <style>
      :root {
        --dark-blue: #0f172a;
        --midnight: #1e293b;
        --highlight: #3b82f6;
      }
      body {
        background-color: var(--dark-blue);
        color: #e2e8f0;
      }
      .post-card {
        transition: transform 0.2s ease-in-out;
      }
      .post-card:hover {
        transform: translateY(-2px);
      }
      .active-tag {
        background-color: var(--highlight);
        color: white;
      }
      .post-content,
      .post-replies {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease;
      }
      .post-content.expanded,
      .post-replies.expanded {
        max-height: 2000px;
      }
      /* Moderator styling */
      .moderator-name {
        color: #60a5fa; /* Bright blue color for moderators */
        font-weight: 600; /* Make it bold */
        display: inline-flex;
        align-items: center;
      }
      .moderator-badge {
        background-color: #1d4ed8; /* Darker blue background */
        color: white;
        font-size: 0.7rem;
        padding: 0.1rem 0.4rem;
        border-radius: 0.25rem;
        margin-left: 0.4rem;
      }
      
      /* New styles for voting */
      .vote-button {
        @apply flex items-center px-2 py-1 rounded transition-colors duration-200;
      }
      .vote-button.upvote {
        @apply hover:text-green-500;
      }
      .vote-button.downvote {
        @apply hover:text-red-500;
      }
      .vote-button.active.upvote {
        @apply text-green-500;
      }
      .vote-button.active.downvote {
        @apply text-red-500;
      }
      .vote-button[disabled] {
        @apply opacity-50 cursor-not-allowed;
      }
      
      /* Improved responsive design */
      @media (max-width: 640px) {
        .post-card {
          @apply mx-2;
        }
        .header-content {
          @apply flex-col items-start space-y-2;
        }
        .vote-buttons {
          @apply flex-col space-y-1;
        }
      }
      /* Add these new styles for sticky sidebar and mobile collapse */
      .sidebar {
        @apply transition-all duration-300 ease-in-out;
      }
      
      @media (min-width: 768px) {
        .sidebar {
          position: sticky;
          top: 6rem; /* Adjust based on header height + desired spacing */
          max-height: calc(100vh - 6rem);
          overflow-y: auto;
        }
      }
      
      @media (max-width: 767px) {
        .sidebar {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          z-index: 40;
          background-color: var(--dark-blue);
          padding: 1rem;
          transform: translateY(-100%);
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar.expanded {
          transform: translateY(4rem); /* Adjust based on header height */
        }
        
        .toggle-sidebar {
          @apply fixed z-50 right-4 bg-slate-800 text-white p-2 rounded-full shadow-lg;
          top: 5rem; /* Position below header */
        }
        
        .toggle-sidebar svg {
          @apply w-6 h-6;
          transition: transform 0.3s ease;
        }
        
        .toggle-sidebar.active svg {
          transform: rotate(180deg);
        }
      }
      
      /* Make sure scrollbar looks good */
      .sidebar::-webkit-scrollbar {
        width: 6px;
      }
      
      .sidebar::-webkit-scrollbar-track {
        background: var(--midnight);
      }
      
      .sidebar::-webkit-scrollbar-thumb {
        background: var(--highlight);
        border-radius: 3px;
      }
      
      /* Updated sidebar styles for better desktop and mobile experience */
      .sidebar {
        @apply transition-all duration-300 ease-in-out;
      }
      
      /* Desktop styles - make sidebar narrower and ensure it fits */
      @media (min-width: 768px) {
        .sidebar {
          position: sticky;
          top: 6rem;
          max-height: calc(100vh - 8rem);
          overflow-y: auto;
          width: 280px; /* Reduced width */
        }
        
        .main-content {
          max-width: calc(100% - 300px); /* Ensure main content has enough space */
        }
      }
      
      /* Mobile styles - make sidebar float and follow scroll */
      @media (max-width: 767px) {
        .sidebar {
          position: fixed;
          top: auto;
          bottom: 0;
          left: 0;
          right: 0;
          z-index: 40;
          background-color: var(--dark-blue);
          padding: 1rem;
          transform: translateY(100%);
          box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
          max-height: 80vh;
          overflow-y: auto;
        }
        
        .sidebar.expanded {
          transform: translateY(0);
        }
        
        /* Overlay when sidebar is open */
        .sidebar-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 39;
        }
        
        .sidebar-overlay.active {
          display: block;
        }
        
        .toggle-sidebar {
          @apply fixed z-50 right-4 bottom-4 bg-blue-600 text-white p-3 rounded-full shadow-lg;
        }
        
        .toggle-sidebar svg {
          @apply w-6 h-6;
          transition: transform 0.3s ease;
        }
        
        .toggle-sidebar.active svg {
          transform: rotate(180deg);
        }
        
        /* Add padding to bottom of main content to account for floating button */
        .main-content {
          padding-bottom: 5rem;
        }
      }
      /* Update mobile toggle button styles */
      @media (max-width: 767px) {
        .toggle-sidebar {
          position: fixed;
          z-index: 50;
          right: 1rem;
          bottom: 1rem; /* Change from top positioning to bottom positioning */
          background-color: #1d4ed8;
          padding: 0.5rem; /* Smaller padding for a more compact button */
          border-radius: 0.25rem; /* Square corners instead of rounded */
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          transition: transform 0.3s ease; /* Change from top to transform for smoother animation */
          width: 2rem; /* Fixed width */
          height: 2rem; /* Fixed height to make it square */
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .hamburger-menu {
          width: 16px; /* Smaller width */
          height: 12px; /* Smaller height */
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        }
        
        .hamburger-menu span {
          display: block;
          height: 2px;
          width: 100%;
          background-color: white;
          transition: all 0.3s ease;
          transform-origin: left center;
        }
        
        .toggle-sidebar.active .hamburger-menu span:nth-child(1) {
          transform: rotate(45deg);
          width: 110%;
        }
        
        .toggle-sidebar.active .hamburger-menu span:nth-child(2) {
          opacity: 0;
          width: 0;
        }
        
        .toggle-sidebar.active .hamburger-menu span:nth-child(3) {
          transform: rotate(-45deg);
          width: 110%;
        }
      }
      
      /* Add styles for better search results handling on mobile */
      #search-results {
        max-height: 60vh; /* Limit height to prevent covering entire screen */
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* Improve scrolling on iOS */
      }
      
      /* Fix for iOS focus issues */
      .search-active body {
        overflow: auto !important;
        position: static !important;
        height: auto !important;
        width: auto !important;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-slate-800 py-4 px-6 shadow-lg sticky top-0 z-10">
      <div class="container mx-auto flex justify-between items-center">
        <a
          href="/"
          class="text-2xl md:text-3xl font-bold text-white tracking-wider"
          >CYBERSHIELD</a
        >
        <div class="flex items-center">
          {% if user.is_authenticated %}
            <div class="flex items-center space-x-2 md:space-x-4">
              <a
                href="{% url 'user_profile' user.username %}"
                class="text-gray-300 hover:text-white border border-slate-500 rounded-md py-1 px-3 md:py-2 md:px-4 hover:bg-slate-700 transition-colors"
                >Profile</a
              >
              <a
                href="{% url 'create_forum' %}"
                class="text-gray-300 hover:text-white border border-slate-500 rounded-md py-1 px-3 md:py-2 md:px-4 hover:bg-slate-700 transition-colors"
                >Post</a
              >
              <a
                href="{% url 'logout' %}"
                class="text-gray-300 hover:text-white border border-slate-500 rounded-md py-1 px-3 md:py-2 md:px-4 hover:bg-slate-700 transition-colors"
                >Logout</a
              >
            </div>
          {% else %}
            <div class="flex items-center space-x-2 md:space-x-4">
              <a
                href="{% url 'login' %}"
                class="text-gray-300 hover:text-white border border-slate-500 rounded-md py-1 px-3 md:py-2 md:px-4 hover:bg-slate-700 transition-colors"
                >Login</a
              >
              <a
                href="{% url 'signup' %}"
                class="bg-blue-600 hover:bg-blue-700 text-white border border-blue-700 rounded-md py-1 px-3 md:py-2 md:px-4 transition-colors"
                >Sign Up</a
              >
            </div>
          {% endif %}
        </div>
      </div>
    </header>

    <main class="container mx-auto flex-grow py-6 px-4 md:px-6">
      <!-- Mobile toggle button -->
      <div class="md:hidden">
        <button class="toggle-sidebar">
          <div class="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </button>
      </div>

      <!-- Mobile overlay -->
      <div class="sidebar-overlay md:hidden"></div>

      <div class="flex flex-col md:flex-row gap-6">
        <!-- Sidebar with filters -->
        <aside class="sidebar w-full md:w-64 lg:w-80">
          <div class="bg-slate-800 rounded-lg shadow-lg p-4 mb-4">
            <h2 class="text-xl font-semibold mb-4">Search</h2>
            <div class="relative">
              <input
                id="search-input"
                type="text"
                placeholder="Search forums..."
                class="w-full bg-slate-700 text-gray-100 border border-slate-600 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <div
                id="search-results"
                class="absolute left-0 right-0 mt-1 bg-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto hidden z-10"
              ></div>
            </div>
          </div>

          <div class="bg-slate-800 rounded-lg shadow-lg p-4">
            <h2 class="text-xl font-semibold mb-4">Filter by Topic</h2>
            <div class="space-y-2">
              <button
                class="filter-tag active-tag w-full py-2 px-3 rounded-md text-left"
                data-tag="all"
              >
                All Topics
              </button>
              {% for tag in forum_tags %}
              <button
                class="filter-tag w-full py-2 px-3 bg-slate-700 hover:bg-slate-600 rounded-md text-left transition-colors"
                data-tag="{{ tag.id }}"
              >
                {{ tag.name }}
              </button>
              {% endfor %}
            </div>
          </div>
        </aside>

        <!-- Main content -->
        <div class="main-content flex-grow">
          <div id="forum-posts">
            {% if forum_posts %} {% for post in forum_posts %}
            <div
              class="post-card bg-slate-800 rounded-lg shadow-lg mb-4 overflow-hidden"
              data-tag="{{ post.forum_tag.id }}"
            >
              <!-- Post header - always visible -->
              <div class="p-4">
                <div class="flex justify-between items-start">
                  <h2 class="text-xl font-semibold flex-grow">{{ post.title }}</h2>
                  <span class="bg-slate-700 text-xs px-2 py-1 rounded ml-2">{{ post.forum_tag.name }}</span>
                </div>
                <div
                  class="flex justify-between items-center mt-4 text-sm text-slate-400"
                >
                  <div class="flex items-center">
                    <span>Posted by 
                      {% if post.author.role == 'moderator' %}
                        <a href="{% url 'user_profile' post.author.username %}" class="moderator-name">
                          {{ post.author.username }}
                          <span class="moderator-badge">Mod</span>
                        </a>
                      {% else %}
                        <a href="{% url 'user_profile' post.author.username %}" class="text-blue-400 hover:text-blue-300">
                          {{ post.author.username }}
                        </a>
                      {% endif %}
                    </span>
                    <span class="mx-2">•</span>
                    <span>{{ post.created_at|date:"M d, Y" }}</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <div class="flex items-center space-x-1">
                      {% if user.is_authenticated %}
                      <button class="vote-button upvote {% if user in post.likes.all %}active{% endif %}" 
                              data-post-id="{{ post.id }}" 
                              data-vote-type="upvote">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                        </svg>
                        <span class="likes-count ml-1">{{ post.likes.count }}</span>
                      </button>
                      <button class="vote-button downvote {% if user in post.dislikes.all %}active{% endif %}"
                              data-post-id="{{ post.id }}"
                              data-vote-type="downvote">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                        <span class="dislikes-count ml-1">{{ post.dislikes.count }}</span>
                      </button>
                      {% else %}
                      <div class="text-sm text-slate-500">
                        <a href="{% url 'login' %}" class="text-blue-400 hover:text-blue-300">Log in</a> to vote
                      </div>
                      {% endif %}
                    </div>
                    <span class="mx-2">•</span>
                    <span>{{ post.forumreply_set.count }} comments</span>
                  </div>
                </div>
                <!-- Change from striptags to safe to preserve formatting -->
                <div class="text-slate-300 line-clamp-2 mb-3 prose prose-invert prose-sm max-w-none">
                  {{ post.content|safe|truncatewords_html:30 }}
                </div>
                <button
                  class="toggle-post mt-3 text-blue-400 hover:text-blue-300 text-sm flex items-center"
                  data-post-id="{{ post.id }}"
                >
                  <span class="show-text">See more</span>
                  <span class="hide-text hidden">Hide</span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="show-icon h-4 w-4 ml-1"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="hide-icon h-4 w-4 ml-1 hidden"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 15l7-7 7 7"
                    />
                  </svg>
                </button>
              </div>

              <!-- Expandable content -->
              <div
                id="content-{{ post.id }}"
                class="post-content border-t border-slate-700"
              >
                <div class="p-4">
                  <!-- Update the prose class to match discussion_detail -->
                  <div class="prose prose-invert max-w-none">
                    {{ post.content|safe }}
                  </div>

                  <!-- Replies section -->
                  <div class="mt-6 pt-4 border-t border-slate-700">
                    <h3 class="text-lg font-medium mb-3">Comments</h3>
                    <div class="space-y-4 replies-container">
                      {% for reply in post.forumreply_set.all %}
                      <div class="bg-slate-700 rounded p-3">
                        <div class="flex justify-between items-start">
                          <p class="text-sm font-medium">
                            {% if reply.author.role == 'moderator' %}
                              <a href="{% url 'user_profile' reply.author.username %}" class="moderator-name">
                                {{ reply.author.username }}
                                <span class="moderator-badge">Mod</span>
                              </a>
                            {% else %}
                              <a href="{% url 'user_profile' reply.author.username %}" class="text-blue-400 hover:text-blue-300">
                                {{ reply.author.username }}
                              </a>
                            {% endif %}
                          </p>
                          <span class="text-xs text-slate-400"
                            >{{ reply.created_at|date:"M d, Y" }}</span
                          >
                        </div>
                        <p class="mt-1 text-slate-300">{{ reply.content }}</p>
                        <div
                          class="flex items-center mt-2 text-xs text-slate-400"
                        >
                          {% if user.is_authenticated %}
                          <div class="flex items-center space-x-2">
                            <button class="vote-button upvote {% if user in reply.likes.all %}active{% endif %}"
                                    data-reply-id="{{ reply.id }}"
                                    data-vote-type="upvote">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                              </svg>
                              <span class="likes-count ml-1">{{ reply.likes.count }}</span>
                            </button>
                            <button class="vote-button downvote {% if user in reply.dislikes.all %}active{% endif %}"
                                    data-reply-id="{{ reply.id }}"
                                    data-vote-type="downvote">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                              </svg>
                              <span class="dislikes-count ml-1">{{ reply.dislikes.count }}</span>
                            </button>
                          </div>
                          {% endif %}
                        </div>
                      </div>
                      {% empty %}
                      <p class="text-sm text-slate-400">
                        No comments yet. Be the first to comment!
                      </p>
                      {% endfor %}
                    </div>

                    {% if user.is_authenticated %}
                    <form class="mt-4 reply-form" data-post-id="{{ post.id }}">
                      {% csrf_token %}
                      <textarea
                        name="content"
                        class="w-full bg-slate-700 text-white border border-slate-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        rows="3"
                        placeholder="Add a comment..."
                      ></textarea>
                      <button
                        type="submit"
                        class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-4 rounded text-sm transition-colors"
                      >
                        Submit
                      </button>
                    </form>
                    {% else %}
                    <p class="mt-4 text-sm text-slate-400">
                      <a
                        href="{% url 'login' %}"
                        class="text-blue-400 hover:underline"
                        >Log in</a
                      >
                      to add a comment.
                    </p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %} {% else %}
            <div class="bg-slate-800 rounded-lg shadow-lg p-6 text-center">
              <p class="text-lg">
                No posts available. Be the first to start a discussion!
              </p>
              {% if user.is_authenticated %}
              <a
                href="{% url 'create_forum' %}"
                class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition-colors"
                >Create Post</a
              >
              {% else %}
              <a
                href="{% url 'signup' %}"
                class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition-colors"
                >Sign Up to Post</a
              >
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 py-8 px-6 mt-12">
      <div class="container mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="mb-6 md:mb-0">
            <h2 class="text-xl font-bold text-white mb-2">CYBERSHIELD</h2>
            <p class="text-slate-400">
              Your secure space for cybersecurity discussions
            </p>
          </div>
          <div
            class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-8"
          >
            <a
              href="{% url 'terms_conditions' %}"
              class="text-slate-400 hover:text-white"
              >Terms & Conditions</a
            >
            <a
              href="{% url 'moderator_form' %}"
              class="text-slate-400 hover:text-white"
              >Become a Moderator</a
            >
          </div>
        </div>
        <div class="mt-8 pt-6 border-t border-slate-700 text-center">
          <p class="text-slate-500">
            &copy; {% now "Y" %} CyberShield. All rights reserved.
          </p>
        </div>
      </div>
    </footer>

    <!-- Scripts -->
    <script>
      $(document).ready(function() {
          // Toggle post content
          $(".toggle-post").click(function() {
              const postId = $(this).data("post-id");
              const contentDiv = $(`#content-${postId}`);

              // Toggle expanded class
              contentDiv.toggleClass("expanded");

              // Toggle icons and text
              $(this).find(".show-text, .hide-text, .show-icon, .hide-icon").toggleClass("hidden");
          });

          // Filter by tags
          $('.filter-tag').on('click', function() {
              $('.filter-tag').removeClass('active-tag').addClass('bg-slate-700');
              $(this).addClass('active-tag').removeClass('bg-slate-700');

              const selectedTag = $(this).data('tag');

              if (selectedTag === 'all') {
                  $('.post-card').show();
              } else {
                  $('.post-card').hide();
                  $(`.post-card[data-tag="${selectedTag}"]`).show();
              }
          });

          // Handle reply form submission
          $(".reply-form").submit(function(e) {
              e.preventDefault();
              const form = $(this);
              const postId = form.data("post-id");
              const content = form.find("textarea[name='content']").val().trim();
              const replyContainer = form.closest(".post-content").find(".replies-container");

              if (!content) return;

              // Send AJAX request to save the reply
              $.ajax({
                  url: '{% url "add_reply" %}',
                  type: 'POST',
                  data: {
                      'post_id': postId,
                      'content': content,
                      'csrfmiddlewaretoken': form.find('input[name=csrfmiddlewaretoken]').val()
                  },
                  success: function(response) {
                      // Add the new reply to the DOM
                      const newReply = `
                          <div class="bg-slate-700 rounded p-3">
                              <div class="flex justify-between items-start">
                                  <p class="text-sm font-medium">
                                    <a href="/user/${response.author}" class="text-blue-400 hover:text-blue-300">
                                      ${response.author}
                                    </a>
                                  </p>
                                  <span class="text-xs text-slate-400">Just now</span>
                              </div>
                              <div class="mt-1 text-slate-300 prose prose-invert prose-sm max-w-none">${content}</div>
                              <div class="flex items-center mt-2 text-xs text-slate-400">
                                  <button class="flex items-center mr-3 hover:text-green-500">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                                      </svg>
                                      0
                                  </button>
                              </div>
                          </div>
                      `;

                      // Find the "no comments" paragraph if it exists and remove it
                      const noCommentsText = replyContainer.find("p.text-sm.text-slate-400");
                      if (noCommentsText.length) {
                          noCommentsText.remove();
                      }

                      // Add the new reply at the top
                      replyContainer.prepend(newReply);

                      // Clear the textarea
                      $(`#content-${postId}`).find("textarea").val("");

                      // Update comments count
                      const commentsCountElement = $(`.post-card[data-tag="${postId}"]`).find("span:contains('comments')");
                      const currentCount = parseInt(commentsCountElement.text());
                      commentsCountElement.text(`${currentCount + 1} comments`);
                  },
                  error: function(xhr, status, error) {
                      console.error(error);
                      alert('An error occurred while submitting your reply. Please try again.');
                  }
              });
          });

          // Like post buttons
          $(".like-button").click(function() {
              const postId = $(this).data("post-id");
              const likeCountElement = $(this).next(".like-count");
              const currentLikes = parseInt(likeCountElement.text());

              // Toggle like/unlike (in a real app, this would call an API)
              $(this).toggleClass("text-green-500 text-gray-400");

              // For demo purposes, just increment the count
              // In a real app, you'd send an AJAX request to your backend
              if ($(this).hasClass("text-green-500")) {
                  likeCountElement.text(currentLikes + 1);
              } else {
                  likeCountElement.text(Math.max(0, currentLikes - 1));
              }
          });

          // Initialize search
          const searchData = [];
          {% for post in forum_posts %}
              searchData.push({
                  id: {{ post.id }},
                  title: "{{ post.title|escapejs }}",
                  content: "{{ post.content|escapejs|truncatechars:100 }}",
                  author: "{{ post.author.username|escapejs }}",
                  forum_tag: "{{ post.forum_tag.name|escapejs }}"
              });
          {% endfor %}

          const fuseOptions = {
              keys: ['title', 'content', 'author', 'forum_tag'],
              threshold: 0.3
          };
          const fuse = new Fuse(searchData, fuseOptions);

          $('#search-input').on('input', function() {
              const query = $(this).val();
              if (query.length < 2) {
                  $('#search-results').hide();
                  return;
              }

              const results = fuse.search(query);

              if (results.length > 0) {
                  let resultsHtml = '';
                  results.forEach(result => {
                      resultsHtml += `
                          <div class="p-3 hover:bg-slate-600 border-b border-slate-600 cursor-pointer" onclick="scrollToPost(${result.item.id})">
                              <div class="font-medium">${result.item.title}</div>
                              <div class="text-sm text-slate-400 mt-1">${result.item.content}</div>
                          </div>
                      `;
                  });

                  $('#search-results').html(resultsHtml).show();
              } else {
                  $('#search-results').html('<div class="p-3">No results found</div>').show();
              }
          });

          $(document).on('click', function(e) {
              if (!$(e.target).closest('#search-input, #search-results').length) {
                  $('#search-results').hide();
              }
          });

          // Add these new functions for mobile sidebar toggle
          $('.toggle-sidebar').click(function() {
              $(this).toggleClass('active');
              $('.sidebar').toggleClass('expanded');
              $('.sidebar-overlay').toggleClass('active');
              
              // Change icon based on state
              const svg = $(this).find('svg');
              if ($(this).hasClass('active')) {
                  svg.html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />');
              } else {
                  svg.html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />');
              }
          });

          // Close sidebar when clicking overlay
          $('.sidebar-overlay').click(function() {
              $('.sidebar').removeClass('expanded');
              $('.toggle-sidebar').removeClass('active');
              $(this).removeClass('active');
              $('.toggle-sidebar svg').html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />');
          });

          // Close sidebar when clicking a filter
          $('.filter-tag').on('click', function() {
              if (window.innerWidth < 768) {
                  $('.sidebar').removeClass('expanded');
                  $('.toggle-sidebar').removeClass('active');
                  $('.sidebar-overlay').removeClass('active');
                  $('.toggle-sidebar svg').html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />');
              }
          });

          // Close sidebar when selecting a search result
          $('#search-results').on('click', 'div', function() {
              if (window.innerWidth < 768) {
                  $('.sidebar').removeClass('expanded');
                  $('.toggle-sidebar').removeClass('active');
                  $('.sidebar-overlay').removeClass('active');
                  $('.toggle-sidebar svg').html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />');
              }
          });

          // Add scroll lock when sidebar is open on mobile
          function toggleScrollLock(lock) {
              if (lock) {
                  $('body').css('overflow', 'hidden');
              } else {
                  $('body').css('overflow', '');
              }
          }

          $('.toggle-sidebar').click(function() {
              if (window.innerWidth < 768) {
                  toggleScrollLock($(this).hasClass('active'));
              }
          });

          $('.sidebar-overlay').click(function() {
              toggleScrollLock(false);
          });

          // Handle window resize
          $(window).resize(function() {
              if (window.innerWidth >= 768) {
                  $('.sidebar-overlay').removeClass('active');
                  toggleScrollLock(false);
              }
          });

          // Rest of your existing script code...
          // ...existing code...
          // Updated scroll handling for toggle button
          let lastScrollTop = 0;
          const header = $('header');
          const headerHeight = header.outerHeight();
          const toggleBtn = $('.toggle-sidebar');
          
          function updateTogglePosition() {
              // No need to adjust position anymore as we're using fixed positioning at the bottom
              // This function is now just a placeholder in case we need to add functionality later
          }
          
          // Remove initial position call
          // updateTogglePosition();
          
          // Remove scroll event handler that was updating the position
          // $(window).scroll(updateTogglePosition);
          
          // Only keep resize handler to handle potential orientation changes
          $(window).resize(function() {
              if (window.innerWidth >= 768) {
                  $('.toggle-sidebar').css('transform', ''); // Reset any transform
              }
          });

          // Handle voting for posts
          $('.vote-button').click(function() {
              if (!$(this).prop('disabled')) {
                  const postId = $(this).data('post-id');
                  const replyId = $(this).data('reply-id');
                  const voteType = $(this).data('vote-type');
                  const button = $(this);
                  const container = button.closest('.post-card, .bg-slate-700');
                  const otherButton = voteType === 'upvote' ? 
                      button.next('.vote-button') : 
                      button.prev('.vote-button');
                  
                  // Determine if this is a post or reply vote
                  const endpoint = replyId ? '{% url "vote_reply" %}' : '{% url "vote_post" %}';
                  const data = replyId ? 
                      { reply_id: replyId, vote_type: voteType } : 
                      { post_id: postId, vote_type: voteType };
                      
                  // Add CSRF token
                  data.csrfmiddlewaretoken = $('input[name=csrfmiddlewaretoken]').val();
                  
                  // Disable buttons during request
                  container.find('.vote-button').prop('disabled', true);
                  
                  $.ajax({
                      url: endpoint,
                      type: 'POST',
                      data: data,
                      success: function(response) {
                          if (response.status === 'success') {
                              // Update vote counts
                              container.find('.likes-count').text(response.likes_count);
                              container.find('.dislikes-count').text(response.dislikes_count);
                              
                              // Remove active class from both buttons
                              button.removeClass('active');
                              otherButton.removeClass('active');
                              
                              // Add active class if vote was added
                              if (response.action === 'added') {
                                  button.addClass('active');
                              }
                          }
                      },
                      error: function(xhr, status, error) {
                          console.error('Vote error:', error);
                      },
                      complete: function() {
                          // Re-enable buttons
                          container.find('.vote-button').prop('disabled', false);
                      }
                  });
              }
          });

          // Improved search handling for mobile
          $('#search-input').on('focus', function() {
              $('body').addClass('search-active');
          });
          
          $('#search-input').on('blur', function() {
              setTimeout(function() {
                  if (!$('#search-results:hover').length) {
                      $('#search-results').hide();
                      // Ensure body returns to normal state
                      $('body').removeClass('search-active');
                  }
              }, 200);
          });
          
          $('#search-input').on('input', function() {
              // ...existing search code...
              
              // Ensure body scroll state is maintained
              $('body').addClass('search-active');
              
              // Make sure search results don't prevent scrolling
              if (query.length < 2) {
                  $('#search-results').hide();
                  return;
              }
              
              // ...rest of the existing search code...
          });
          
          // Ensure clicking outside search properly restores scrolling
          $(document).on('click', function(e) {
              if (!$(e.target).closest('#search-input, #search-results').length) {
                  $('#search-results').hide();
                  $('body').removeClass('search-active');
              }
          });
          
          // Update scrollToPost to maintain scroll behavior
          window.scrollToPost = function(postId) {
              const postElement = document.querySelector(`.toggle-post[data-post-id="${postId}"]`).closest('.post-card');
              
              if (postElement) {
                  // Ensure scrolling is enabled
                  $('body').removeClass('search-active');
                  
                  // Close search results before scrolling
                  $('#search-results').hide();
                  
                  // Add a small delay to ensure UI is ready before scrolling
                  setTimeout(function() {
                      postElement.scrollIntoView({ behavior: 'smooth' });
                      
                      // Open the post content automatically
                      const contentDiv = $(`#content-${postId}`);
                      contentDiv.addClass("expanded");
                      
                      // Update toggle button
                      const toggleBtn = $(`.toggle-post[data-post-id="${postId}"]`);
                      toggleBtn.find(".show-text").addClass("hidden");
                      toggleBtn.find(".hide-text").removeClass("hidden");
                      toggleBtn.find(".show-icon").addClass("hidden");
                      toggleBtn.find(".hide-icon").removeClass("hidden");
                      
                      // Highlight the post temporarily
                      postElement.classList.add('ring-2', 'ring-blue-500');
                      setTimeout(() => {
                          postElement.classList.remove('ring-2', 'ring-blue-500');
                      }, 2000);
                  }, 100);
              }
          };
      });
    </script>

    <!-- Add Tailwind Typography plugin styles for better rich content rendering -->
    <style>
      /* Basic prose styling for rich content */
      .prose img {
        max-width: 100%;
        height: auto;
        border-radius: 0.375rem;
      }
      
      .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
        color: #f8fafc;
        margin-top: 1.5em;
        margin-bottom: 0.75em;
        font-weight: 600;
      }
      
      .prose p {
        margin-top: 1em;
        margin-bottom: 1em;
      }
      
      .prose ul, .prose ol {
        margin-top: 1em;
        margin-bottom: 1em;
        padding-left: 1.5em;
      }
      
      .prose ul {
        list-style-type: disc;
      }
      
      .prose ol {
        list-style-type: decimal;
      }
      
      .prose a {
        color: #60a5fa;
        text-decoration: underline;
      }
      
      .prose strong, .prose b {
        font-weight: 600;
        color: #f1f5f9;
      }
      
      .prose-sm {
        font-size: 0.875rem;
      }
      
      .prose blockquote {
        border-left: 4px solid #475569;
        padding-left: 1em;
        font-style: italic;
        margin: 1em 0;
      }
      
      .prose code {
        background-color: #1e293b;
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
        font-size: 0.875em;
      }
      
      .prose pre {
        background-color: #1e293b;
        padding: 1em;
        border-radius: 0.375rem;
        overflow-x: auto;
        margin: 1em 0;
      }
    </style>
  </body>
</html>
